
pipeline {
    agent any
    
    environment {
        ang_dir = 'angular'
        java_dir = 'java/jtqj'
        src_dir = 'angular/src'
        sonarEnv = 'sonarqube'
        scannerHome = 'SonarQube scanner'
        
    }
    tools{
        maven 'mvn'
        nodejs 'NodeJs'
    }
    stages {        
        stage('Install dependencies') {
            steps {
                dir(ang_dir){
                    //sh 'yarn --network-timeout 100000'
                    sh 'npm install'
                }
            }
        }
        stage('Test front') {
            steps {
                dir(ang_dir){
                    sh 'ng test --code-coverage' 
                    sh 'ng lint'
                }
            }
        }
        stage('SonarQube Analysis Front') {
            steps{
                script {
                    dir(ang_dir) {
                        def scannerHome = tool sonarHome
                        def props = readJSON file: 'package.json'
                        withSonarQubeEnv(sonarEnv) {
                            sh """
                                ${scannerHome}/bin/sonnar-scanner \
                                    -Dsonar.host.url=http://127.0.0.1:9000/ \
                                    -Dsonar.projectKey=jtq_angular \
                                    -Dsonar.projectName=jtq_angular \
                                    -Dsonar.sources=${src_dir}
                            """
                        }
                    }
                }
            }
        }
        stage('Build frontend') {
            steps {
                dir(ang_dir){
                    sh 'npm run build'
                }
            }
        }
        stage('Build backend') {
            steps {
                dir(java_dir){
                    sh 'mvn clean install -Dmaven.test.skip=true'
                    }
                }
            
        }
        stage('Test backend') {
            steps {
                dir(java_dir){
                    sh 'mvn clean test'
                }
            }
        }   

        stage('SonarQube Analysis Back') {
            steps{
                script{
                    dir(java_dir){
                        withSonarQubeEnv(sonarEnv) {
                            sh "mvn sonar:sonar -Dsonar.projectKey=jtq_java \
                                    -Dsonar.projectName=jtq_java \
                                    -Dsonar.sources=${java_dir} \
                                    -Dsonar.dependencyCheck.reportPath=../../dependency-check-report.xml"
                        }
                    }
                }
            }
        }
        stage('Build image frontend') {
            steps {
                script {
                    def frontImage = docker.build("frontend:${env.BUILD_ID}", "-f ${dockerfile} ./java")
                    frontImage.push()
                }
            }
        }
        stage('Build image backend') {
            steps {
                script {
                    def backImage = docker.build("backend:${env.BUILD_ID}", "-f ${dockerfile} ./angular")
                    backIMage.push()
                }
            }
        }
        stage('Build image reverse_proxy') {
            steps {
                script {
                    def reverseImage = docker.build("reverseImage:${env.BUILD_ID}", "-f ${dockerfile} ./nginx")
                    reverseImage.push()
                }
            }
        }
    }
    
        
}
